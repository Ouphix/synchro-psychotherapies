---
title: "Synchrony in Psychotherapy, example with F1044 patient data"
author: "Thomas Gargot"
date: "2 mars 2016"
output: 
  pdf_document: 
    toc: yes
---

```{r, echo=FALSE, eval=TRUE, cache=TRUE}
list <- list.files("CSV/csvF104422022016", full.names=TRUE)

importdata <-function(fileslist){
    data <- c()
    for (i in list){
        dataAlone <-read.csv(paste("/Users/Ofix/Documents/Fac/internat/Recherche/projets/synchro/synchroData/Git/", i, sep=""))
        data <- rbind(data, dataAlone)}
    return (data)}
```

# Lists
## Functions list
###MeanMomentumByTime
Function that takes raw motion history data and make mean on a given interval. Intervals don't overlap, so the frequency of the data change (from 25 frames by seconde to 25 frames/interval by second).

#####Arguments:
- subject : Subject studied (patient, mother, father or therapist)
- indexOfvideos : List of videos studied (element eg 3 or list eg 1:3 or c(1,2,4))
- interval : number of frames in the studied interval
- data : data frame where there is data

```{r, echo=TRUE, eval=TRUE, cache=TRUE}
MeanMomentumByTime <- function(subject, indexOfvideos=1:NumberOfvideos, interval, data){
  x <- c()
  for (file in indexlist[indexOfvideos]){
        dataVector <- data[which(data$file==file), subject]
        ## with ceiling : superior limit of the round
        IntervalNumbersVideo <- ceiling(length(dataVector)/interval)
        for (i in 1:IntervalNumbersVideo){
                borneinf<- 1+(i-1)*interval
                bornesup <-i*interval
                dataVectorInterval <- dataVector[borneinf:bornesup]
                mean <- mean(dataVectorInterval, na.rm=TRUE)
                x <- c(x, mean)}}
  return (x)}
```

###Slidinginterval
Function that takes raw motion history data and make mean on a given interval. The interval overlap, so the frequency of the data don't change. It stays at 25 frames/s.

####Arguments:
- subject : subject studied (patient, mother, father or therapist)
- indexOfvideos : list of videos studied (element eg. 3 or list eg 1:3 or c(1,2,4))
- interval : number of frames in the studied interval
- data : data frame where there is data

```{r}
SlidingInterval <- function(subject, indexOfvideos=1:NumberOfvideos, interval, data)
  {x <- c()
  for (file in indexlist[indexOfvideos]){
      dataVector <- data[which(data$file==file), subject]
      NBofAnalysedframes <- length(dataVector)-interval+1
          for (i in 1:NBofAnalysedframes){
              borneinf<- (i)
              bornesup <-(interval-1+i)
              dataVectorInterval <- dataVector[borneinf:bornesup]
              mean <- mean(dataVectorInterval, na.rm=TRUE)
              x <- c(x, mean)}}
  return (x)}
```

## File lists
```{r, echo=TRUE, eval=TRUE, cache=TRUE}
indexlist <- c("F1044C.VOB","F1044D1.VOB","F1044D2.VOB","F1044E.VOB","F1044F.VOB",
               "F1044G.VOB","F1044H.VOB","F1044I.VOB","F1044L.VOB","F1044M1.VOB",
               "F1044M2.VOB","F1044N.VOB", "F1044O.VOB", "F1044P.VOB", "F1044Q.VOB",
               "F1044R1.VOB","F1044R2.VOB")

labelvideolist<- c("C","D1","D2","E","F", "G","H","I","L","M1", "M2","N", "O", "P", "Q",
                   "R1","R2")

NumberOfvideos <- length(indexlist)

colOrderList <- c("blue","red", "green","orange")
```

## Participants list
```{r, echo=FALSE, eval=TRUE, cache=TRUE}
data <- importdata(list)
ParticipantsList <- names(data[,2:5])
print(ParticipantsList)
data$timeMin <- data$frame/(25*60)
```

# Presentation of the data
The timeMin is corresponding to a frame rate 25/sec.
```{r}
str(data)
summary(data)
```

# Length of the videos in minutes
```{r, echo=FALSE, cache=TRUE}
videoLengthList <-c()
for (i in indexlist){
  index<-which(data$file==i)
  videolength <- max (data$timeMin[index])
  videoLengthList <-c(videoLengthList,videolength)}

#print(videoLengthList)

par(mar=c(4,4,3,1))
barplot(videoLengthList, col="cornflowerblue", cex.axis=0.6, cex.names=0.6,
        ylab="Minutes", xlab="Video Name", las=1, names=labelvideolist, 
        main="Length in each F1044 video (min)")
        abline(h = mean(videoLengthList), lwd=2, lty=2)
        text(20,20, "Mean")
```

## Length of the videos in number of frames
```{r, echo=FALSE, cache=TRUE}
barplot(table(data$file), col="cornflowerblue", cex.axis=0.6, cex.names=0.5, cex.lab=0.8,
        main="Number of frames in each F1044 video", cex.main=0.8, ylab="Frame number", 
        names = labelvideolist, xlab="Video Name", las=1)
```

## Number of Available (True) and Not Available (False) data for each participant
```{r, echo=FALSE, fig.height=3}
tab <- cbind(table(is.na(data[,2])),table(is.na(data[,3])),table(is.na(data[,4])), 
                                                          table(is.na(data[,5])))

par(mar=c(3,3,2,1))
barplot(tab, cex.axis = 0.7, las=2, cex.main= 1, names=ParticipantsList, 
  main="Number of available data by participant", 
  beside=TRUE, las=1, col=terrain.colors(2), ylim=c(0,600000))
legend("topright", c("T", "F"), fill=terrain.colors(2))
```

Mother and therapist are the more often present participants.

# Global Motion history
## Mean Motion history by video by participant
```{r, echo=FALSE, fig.height=4}
meanMomentumList <-c()
meanMomentum <- function(subject){
    for (i in indexlist){
              index <- which(data$file==i)
              momentumsubject<- mean(data[index,subject], na.rm=TRUE)
              meanMomentumList <-c(meanMomentumList, momentumsubject)}
  return (meanMomentumList)}

momentumfatherlist <- meanMomentum("father")
momentumMotherList <- meanMomentum("mother")
momentumTherapistList <- meanMomentum("therapist")
momentumPatientList <- meanMomentum("patient")

momentumMeanList <- rbind(momentumfatherlist, momentumMotherList, momentumPatientList, momentumTherapistList)

par(mar=c(3,3,2,1))
barplot(momentumMeanList, names=labelvideolist, las=1, cex.axis = 0.4, cex.names=0.6, 
        main="Mean Motion history in each video", beside=TRUE, 
        col=colOrderList)
par(mar=c(1,0.5,0.5,1))
legend("top", inset=.05, ParticipantsList, 
       fill=colOrderList, cex=0.7)
```

## Motion history box plots by frame (raw data), all videos
```{r, echo=FALSE, cache=TRUE}
par(mar=c(3,3,2,2))
boxplot(data$father, data$mother, data$therapist, data$patient, 
        col=colOrderList, 
        names=ParticipantsList, 
        main= "Motion history by frame box plots (raw data), all videos", las=1)
par(mar=c(1,0.5,0.5,1))
legend("topleft", ParticipantsList, fill=colOrderList, cex=0.7)
```

# Raw data and mean of Motion History on sliding and non overlapping intervals on F1044C video
## F1044C video
It is the first video of F10044C. The father, mother and therapist are present. The patient is absent.

## Raw data
```{r, cache=TRUE}
rawdatafather <- data[which(data$file=="F1044C.VOB"),]$father
rawdataMother <- data[which(data$file=="F1044C.VOB"),]$mother
rawdataTherapist <- data[which(data$file=="F1044C.VOB"),]$therapist

par(mar=c(3,3,3,2))
boxplot(rawdatafather, rawdataMother, rawdataTherapist,
        col=colOrderList[c(1,2,4)], 
        names=ParticipantsList[c(1,2,4)], 
        main= "Box plots of motion history mean 
on 11 frames rawdata on F1044C video", las=1)
par(mar=c(1,0.5,0.5,1))
legend("topleft", ParticipantsList[c(1,2,4)], fill=colOrderList, cex=0.7)

summary(rawdatafather)
summary(rawdataMother)
summary(rawdataTherapist)
```

## Sliding interval
```{r, cache=TRUE}
## REMINDER:
#SlidingInterval <- function(subject, indexOfvideos=1:NumberOfvideos, interval, data) with :
# subject : subject studied (patient, mother, father or therapist)
# indexOfvideos : list of videos studied (element eg. 3 or list eg 1:3 or c(1,2,4)) 
# interval : number of frames in the studied interval
# data : data frame where there is data

# avant 1ere video
# avant 11 intervalles
slidedfather <- SlidingInterval("father", 7 , 5, data)
slidedmother <- SlidingInterval("mother", 7 , 5, data)
slidedtherapist <- SlidingInterval("therapist", 7 , 5, data)
slidedpatient <- SlidingInterval("patient", 7 , 5, data)

par(mar=c(3,3,2,2))
boxplot(slidedfather, slidedmother, slidedtherapist,
        col=colOrderList[c(1,2,4)], 
        names=ParticipantsList[c(1,2,4)], 
        main= "Box plot of motion history sliding interval on F1044C video", las=1)
par(mar=c(1,0.5,0.5,1))
legend("topleft", ParticipantsList[c(1,2,4)], fill=colOrderList, cex=0.7)

summary(slidedfather)
summary(slidedmother)
summary(slidedtherapist)
```

## Non overlapping interval
```{r, cache=TRUE}
fatherEleven<- MeanMomentumByTime("father", indexOfvideos=1, interval=11, data)

motherEleven <- MeanMomentumByTime("mother", indexOfvideos=1, interval=11, data)

therapistEleven <- MeanMomentumByTime("therapist", indexOfvideos=1, interval=11, data)

par(mar=c(3,3,3,2))
boxplot(fatherEleven, motherEleven, therapistEleven,
        col=colOrderList[c(1,2,4)], 
        names=ParticipantsList[c(1,2,4)], 
        main= "Box plots of motion history mean 
on 11 frames non overlapping interval for F1044C video", las=1)
par(mar=c(1,0.5,0.5,1))
legend("topleft", ParticipantsList[c(1,2,4)], fill=colOrderList[c(1,2,4)], cex=0.7)

summary(fatherEleven)
summary(motherEleven)
summary(therapistEleven)
```

# Focus on the motion history of the first 20 seconds of the first video(C) 
## Sliding interval function on a 11 frames interval
```{r, cache=FALSE}
par(mar=c(4,4,4,2))
plot(1:250, data$father[6:255], main="Mean motion history (Sliding 11 frames interval) 
     for father on F1044C video, 10 seconds ", xlab="Frame index (25/s)",
     ylab="Motion history",
     col="blue", type="l", lty=2, lwd=0.5)
lines(slidedfather[1:250],  col="blue", lty=1)
lines(data$mother[6:255],  col="red", lty=2, lwd=0.5)
lines(slidedmother[1:250],  col="red", lty=1)
lines(data$therapist[6:255],  col="orange", lty=2, lwd=0.5)
lines(slidedtherapist[1:250],  col="orange", lty=1)
legend("topleft", c("Raw data", "Mean on sliding Interval") , lty=c(2, 1), cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList[c(1,2,4)], cex=0.7)
```

## Sliding interval function on a 11 frames interval with shifting of therapist (substraction of min value of therapist)
```{r, cache=FALSE}
par(mar=c(4,4,4,2))
plot(1:250, data$father[6:255], main="Mean motion history (Sliding 11 frames interval) 
     for father on F1044C video, 10 seconds, data therapist shifted", xlab="Frame index (25/s)", ylab="Motion history",
     col="blue", type="l", lty=2, lwd=0.5)
lines(slidedfather[1:250],  col="blue", lty=1)
lines(data$mother[6:255],  col="red", lty=2, lwd=0.5)
lines(slidedmother[1:250],  col="red", lty=1)
lines(data$therapist[6:255],  col="orange", lty=2, lwd=0.5)
lines(slidedtherapist[1:250]-min(slidedtherapist),  col="orange", lty=1)
legend("topleft", c("Raw data", "Mean on sliding Interval") , lty=c(2, 1), cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList[c(1,2,4)], cex=0.7)
```

### Non overlapping interval function on a 11 frames interval
```{r, cache=FALSE}
plot (1:24, fatherEleven[1:24], type="l", col="blue", 
main="Mean Motion history (non overlapping 11 frames
      intervals) for father on F1044C video, first 10 seconds", 
ylab="Motion history", xlab="Frame index (each 11 frames)" )
lines(motherEleven[1:24], col="red", lty=1)
lines(therapistEleven[1:24], col="green", lty=1)
legend("topleft", "Mean on non overlapping Interval" , lty=1, cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList, cex=0.7)
```

### Non overlapping interval function on a 11 frames interval with shifting of therapist (substraction of min value of therapist)
```{r, cache=FALSE}
plot (1:24, fatherEleven[1:24], type="l", col="blue", 
main="Mean motion history (non overlapping 11 frames
      intervals) for father on F1044C video, first 10 seconds, data therapist shifted", 
ylab="Motion history", xlab="Frame index (each 11 frames)" )
lines(motherEleven[1:24], col="red", lty=1)
lines(therapistEleven[1:24]-min(slidedtherapist), col="green", lty=1)
legend("topleft", "Mean on non overlapping Interval" , lty=1, cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList, cex=0.7)
```

## Motion history of the father during 10-20 seconds of the first video(C) 
### Non overlapping interval function on a 11 frames interval
```{r, cache=FALSE}
par(mar=c(4,4,4,2))
plot(1:250, data$father[256:505], main="Mean motion history (Sliding 11 frames
     interval) for father on F1044C video, 10-20 seconds", xlab="Frame index (25/s)", 
     ylab="Motion history", col="blue", type="l", lty=2, lwd=0.5)
lines(slidedfather[251:500],  col="blue", lty=1)
lines(data$mother[256:505],  col="red", lty=2, lwd=0.5)
lines(slidedmother[251:500],  col="red", lty=1)
lines(data$therapist[256:505],  col="orange", lty=2, lwd=0.5)
lines(slidedtherapist[251:500],  col="orange", lty=1)
legend("topleft", c("Raw data", "Mean on sliding Interval") , lty=c(2, 1), cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList[c(1,2,4)], cex=0.7)
```

### Non overlapping interval function on a 11 frames interval with shifting of therapist (substraction of min value of therapist)
```{r, cache=FALSE}
par(mar=c(4,4,4,2))
plot(1:250, data$father[256:505], main="Mean motion history (Sliding 11 frames
     interval) for father on F1044C video, 10-20 seconds, 
     data therapist shifted", xlab="Frame index (25/s)", ylab="Motion history", col="blue", 
     type="l", lty=2, lwd=0.5)
lines(slidedfather[251:500],  col="blue", lty=1)
lines(data$mother[256:505],  col="red", lty=2, lwd=0.5)
lines(slidedmother[251:500],  col="red", lty=1)
lines(data$therapist[256:505],  col="orange", lty=2, lwd=0.5)
lines(slidedtherapist[251:500]-min(slidedtherapist),  col="orange", lty=1)
legend("topleft", c("Raw data", "Mean on sliding Interval") , lty=c(2, 1), cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList[c(1,2,4)], cex=0.7)
```

### Non overlapping interval function on a 11 frames interval
```{r, cache=FALSE}
plot (1:24, fatherEleven[23:46], type="l", col="blue", 
main="Mean motion history (non overlapping 11 frames intervals) for 
father on F1044C video, between 10-20 seconds", 
ylab="Motion history", xlab="Frame index (each 11 frames)", ylim=c(0, 0.009))
lines(motherEleven[23:46], col="red", lty=1)
lines(therapistEleven[23:46], col="green", lty=1)
legend("top", "Mean on non overlapping Interval" , lty=1, cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList, cex=0.7)
```

### Non overlapping interval function on a 11 frames interval with shifting of therapist (substraction of min value of therapist)
```{r, cache=FALSE}
plot (1:24, fatherEleven[23:46], type="l", col="blue", 
main="Mean motion history (non overlapping 11 frames intervals) for 
father on F1044C video, between 10-20 seconds, 
data therapist shifted", 
ylab="Motion history", xlab="Frame index (each 11 frames)", ylim=c(0, 0.009))
lines(motherEleven[23:46], col="red", lty=1)
lines(therapistEleven[23:46]-min(slidedtherapist), col="green", lty=1)
legend("top", "Mean on non overlapping Interval" , lty=1, cex=0.7)
legend("topright", ParticipantsList[c(1,2,4)], fill=colOrderList, cex=0.7)
```

# Mean motion history by minute plots
```{r, fig.height=4}
for (i in 1:NumberOfvideos){
  fatherMinute<- MeanMomentumByTime("father", indexOfvideos=i, interval=1500, data)
  
  MotherMinute<- MeanMomentumByTime("mother", indexOfvideos=i, interval=1500, data)

  TherapistMinute<- MeanMomentumByTime("therapist", indexOfvideos=i, interval=1500, data)

  PatientMinute<- MeanMomentumByTime("patient", indexOfvideos=i, interval=1500, data)

length(fatherMinute)
  
  par(mar=c(4,4,4,2))
      plot (1:length(fatherMinute), fatherMinute, type="l", col="blue", 
      main=paste("Mean motion history (non overlaping minute intervals) 
      on F1044", labelvideolist[i], " video" , sep=""), 
      ylab="Motion history", xlab="Time by Minute", ylim=c(0, 12E-03), 
      xaxp=c(0, length(fatherMinute), length(fatherMinute)))
      lines(MotherMinute, col="red")
      lines(TherapistMinute, col="orange")
      lines(PatientMinute, col="green")
      legend("top", inset=.05, ParticipantsList, 
             fill=colOrderList, cex=0.7)}
```

labelvideolist

# Export data in text files
```{r, eval=FALSE}
# slidedfatherwoNA <- slidedfather[which(is.na(slidedfather)==FALSE)]
# slidedmotherwoNA <- slidedmother[which(is.na(slidedmother)==FALSE)]
# slidedtherapistwoNA <- slidedtherapist[which(is.na(slidedtherapist)==FALSE)]
# slidedpatientwoNA <- slidedpatient[which(is.na(slidedpatient)==FALSE)]

#__________________________________________

## REMINDER:
#SlidingInterval <- function(subject, indexOfvideos=1:NumberOfvideos, interval, data) with :
# subject : subject studied (patient, mother, father or therapist)
# indexOfvideos : list of videos studied (element eg. 3 or list eg 1:3 or c(1,2,4)) 
# interval : number of frames in the studied interval
# data : data frame where there is data

dfExport <- data.frame()
for (i in indexlist){
  datFile <- data[which(data$file==i),]
  print(datFile)
  numberOfFilesList <- 1:length(indexlist)
  print(numberOfFilesList)
  slidedfather <- SlidingInterval("father", 1:3, 5, datFile)
  print(3)
  slidedmother <- SlidingInterval("mother", numberOfFilesList, 5, datFile)
  slidedtherapist <- SlidingInterval("therapist", numberOfFilesList, 5, datFile)
  slidedpatient <- SlidingInterval("patient", numberOfFilesList, 5, datFile)
    dfNew <- data.frame(slidedfather, slidedmother, slidedtherapist, slidedpatient, 1:length(slidedfather), rep(i,length(slidedfather)))
  dfExport <- rbind(dfExport, dfNew)
}

length(slidedmother)
1:length(slidedmother)
rep("F1044C.VOB",length(slidedmother))

dfexport <- data.frame(slidedfather, slidedmother, slidedtherapist, slidedpatient)
#dfexport <- data.frame(slidedpatient, slidedmother, slidedtherapist)
write.csv(dfexport, "/Users/Ofix/Documents/Fac/internat/Recherche/projets/synchro/synchroData/slideddata.csv") 
```

# SyncPy utilisation for creating synchrony dataframe
### After extracting filtered motion motion history with mean on non overlapping interval of 11 frames
### And after puting this data on a CSV file
### We import this data on python Script with panda module [Call_S_Estimator.py](/SyncPy/examples/Call_S_Estimator.py)
### This script will calculate the synchrony between each dyad of the interaction and of the whole group
### It will return a csv file [SSI.csv](/SyncPy/examples/SSI.csv) that we can import with R with
### this following function

```{r, echo=FALSE}
getwd()
setwd("/SyncPy/examples/")
SSI <- read.csv("SSI.csv")
```

## Description of SSI data frame
```{r}
str(SSI)
```

## Synchrony scores for each dyad and for the whole group
```{r}
par(mar=c(4,4,4,3))
plot(SSI$Time_min, SSI$SSI_fa_mo, type="l", col=rainbow(4)[1], main=paste("Synchrony scores for each dyad and for \n the whole group in", SSI$filename[1], "video"), xlab = "Time (minute)", ylab="Synchrony score", lwd=2, xaxp=c(0, length(SSI$SSI_fa_mo), length(SSI$SSI_fa_mo)))
abline(h=mean(SSI$SSI_fa_mo), col=rainbow(4)[1], lwd=2, lty=2)

lines(SSI$SSI_fa_th, col=rainbow(4)[2], lwd=2)
abline(h= mean(SSI$SSI_fa_th), col=rainbow(4)[2], lwd=2, lty=2 )

lines(SSI$SSI_mo_th, col=rainbow(4)[3], lwd=2)
abline(h= mean(SSI$SSI_mo_th), col=rainbow(4)[3], lwd=2, lty=2)

lines(SSI$SSI_fa_mo_th, col=rainbow(4)[4], lwd=2)
abline(h= mean(SSI$SSI_fa_mo_th), col=rainbow(4)[4], lwd=2, lty=2)

legend("topleft", inset=.05, c("fa_mo", "fa_th", "mo_th", "fa_mo_th"), 
             col=rainbow(4), cex=0.6, lwd=2)
legend("topright", inset=.05, c(
paste ("Mean fa_mo :", round(mean(SSI$SSI_fa_mo),3)), 
paste ("Mean fa_th :", round(mean(SSI$SSI_fa_th),3)),
paste ("Mean mo_th :", round(mean(SSI$SSI_mo_th),3)),
paste ("Mean fa_mo_th :", round(mean(SSI$SSI_fa_mo_th),3))
), col=rainbow(4), cex=0.5, lty=2, lwd=1)   
```

time <- (as.double(SSI$Time_min)/6)
length(time)
length(SSI$SSI_mo_pa)
```{r}
plot(time, SSI$SSI_mo_pa, type="l", col=rainbow(4)[1], main=paste("Synchrony scores for each dyad and for \n the whole group in", SSI$filename[1], "video"), xlab = "Time (minute)", ylab="Synchrony score", lwd=2, xaxp=c(0, length(SSI$SSI_mo_pa), length(SSI$SSI_mo_pa)))
abline(h=mean(SSI$SSI_mo_pa), col=rainbow(4)[1], lwd=2, lty=2,
       
lines(SSI$SSI_pa_th, col=rainbow(4)[2], lwd=2)
abline(h= mean(SSI$SSI_pa_th), col=rainbow(4)[2], lwd=2, lty=2 )

lines(SSI$SSI_mo_th, col=rainbow(4)[3], lwd=2)
abline(h= mean(SSI$SSI_mo_th), col=rainbow(4)[3], lwd=2, lty=2)

lines(SSI$SSI_mo_pa_th, col=rainbow(4)[4], lwd=2)
abline(h= mean(SSI$SSI_mo_pa_th), col=rainbow(4)[4], lwd=2, lty=2)

legend("topleft", inset=.05, c("mo_pa", "pa_th", "mo_th", "mo_pa_th"), 
             col=rainbow(4), cex=0.6, lwd=2)
legend("topright", inset=.05, c(
paste ("Mean mo_pa :", round(mean(SSI$SSI_mo_pa),3)), 
paste ("Mean pa_th :", round(mean(SSI$SSI_pa_th),3)),
paste ("Mean mo_th :", round(mean(SSI$SSI_mo_th),3)),
paste ("Mean mo_pa_th :", round(mean(SSI$SSI_mo_pa_th),3))
), col=rainbow(4), cex=0.5, lty=2, lwd=1) 
```

length(slidedmother)
1:length(slidedmother)

plot(1:length(slidedmother), slidedmother, type="l")
